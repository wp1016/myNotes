<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js事件循环机制 | 我的学习记录</title>
    <meta name="description" content="学习记录">
    
    
    <link rel="preload" href="/assets/css/0.styles.7dc567d6.css" as="style"><link rel="preload" href="/assets/js/app.858ddfaa.js" as="script"><link rel="preload" href="/assets/js/2.5004e8d4.js" as="script"><link rel="preload" href="/assets/js/12.ad72436a.js" as="script"><link rel="prefetch" href="/assets/js/10.1937ac51.js"><link rel="prefetch" href="/assets/js/11.476302ee.js"><link rel="prefetch" href="/assets/js/13.433e10e3.js"><link rel="prefetch" href="/assets/js/14.6204aac5.js"><link rel="prefetch" href="/assets/js/15.21b7313f.js"><link rel="prefetch" href="/assets/js/16.c674646e.js"><link rel="prefetch" href="/assets/js/3.19f73dc2.js"><link rel="prefetch" href="/assets/js/4.326d6dc7.js"><link rel="prefetch" href="/assets/js/5.7bbbddb3.js"><link rel="prefetch" href="/assets/js/6.19c01d84.js"><link rel="prefetch" href="/assets/js/7.6da62fb6.js"><link rel="prefetch" href="/assets/js/8.fa3b98eb.js"><link rel="prefetch" href="/assets/js/9.31efd1cb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7dc567d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">我的学习记录</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/algorithms/" class="nav-link">数据结构</a></div><div class="nav-item"><a href="/http/" class="nav-link">网络协议</a></div><div class="nav-item"><a href="/docs/" class="nav-link">中文文档</a></div><div class="nav-item"><a href="/js/" class="nav-link router-link-active">js基础</a></div><div class="nav-item"><a href="/records/" class="nav-link">采坑记录</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/algorithms/" class="nav-link">数据结构</a></div><div class="nav-item"><a href="/http/" class="nav-link">网络协议</a></div><div class="nav-item"><a href="/docs/" class="nav-link">中文文档</a></div><div class="nav-item"><a href="/js/" class="nav-link router-link-active">js基础</a></div><div class="nav-item"><a href="/records/" class="nav-link">采坑记录</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js判断鼠标进入方向</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>js事件循环机制</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/js事件循环机制.html" class="active sidebar-link">js事件循环机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/js事件循环机制.html#js单线程、异步、同步概念" class="sidebar-link">JS单线程、异步、同步概念</a></li><li class="sidebar-sub-header"><a href="/js/js事件循环机制.html#事件循环机制" class="sidebar-link">事件循环机制</a></li><li class="sidebar-sub-header"><a href="/js/js事件循环机制.html#任务队列" class="sidebar-link">任务队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/js事件循环机制.html#任务队列的类型" class="sidebar-link">任务队列的类型</a></li><li class="sidebar-sub-header"><a href="/js/js事件循环机制.html#更完整的时间循环流程" class="sidebar-link">更完整的时间循环流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/js事件循环机制.html#示例、验证" class="sidebar-link">示例、验证</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js事件循环机制"><a href="#js事件循环机制" class="header-anchor">#</a> js事件循环机制</h1> <h2 id="js单线程、异步、同步概念"><a href="#js单线程、异步、同步概念" class="header-anchor">#</a> JS单线程、异步、同步概念</h2> <p>众说周知，JS是单线程（如果一个线程删DOM，一个线程增加DOM，浏览器傻逼了~所以只能单着了），虽然有webworker酱紫的多线程出现，但也是在主线程的控制下。webworker仅仅能进行计算任务，不能操作DOM，所以本质上还是单线程。</p> <p>单线程即任务是串行的，后一个任务需要等待前一个任务的执行。这就可能出现长时间的等待。但由于类似ajax网络请求、setTimeout时间延迟、DOM时间的用户交互等，这些任务并不消耗CPU，是一种空等，资源浪费，因此出现了异步。通过将任务交给相应的异步模块去处理，主线程的效率大大提升，可以并行的去处理其他操作。当异步处理完成，主线程空闲时，主线程读取相应的callback，进行后续的操作，最大程度的利用CPU。此时出现了同步执行和异步执行的概念，同步执行是主线程按照顺序，串行执行任务；异步执行是cpu跳过等待，先处理后续的任务（CPU与网络模块、timer等并行进行任务）。由此产生了任务队列与事件循环，来协调主线程与异步模块之间的工作。</p> <h2 id="事件循环机制"><a href="#事件循环机制" class="header-anchor">#</a> 事件循环机制</h2> <p><img src="https://images2015.cnblogs.com/blog/1094893/201704/1094893-20170419140631852-1337804828.png" alt="image"></p> <p>上图流程如下：</p> <ol><li>主线程读取JS代码，此时为同步环境，形成相应的堆和执行栈；</li> <li>主线程遇到异步任务，指给对应的异步进程进行处理（WEB API）；</li> <li>异步进程处理完毕（Ajax返回、DOM事件处罚、Timer到等），将相应的异步任务推入任务队列；</li> <li>主线程执行完毕，查询任务队列，如果存在任务，则取出一个任务推入主线程（先进先出）；</li> <li>重复执行2、3、4；称为事件循环
执行的大意：</li></ol> <p>同步环境执行--&gt;事件循环1--&gt;事件循环2。。。</p> <p>其中的异步进程有：</p> <ol><li>类似onclick等，由浏览器内核的DOM binding模块处理，事件触发时，回调函数添加到任务队列中；</li> <li>setTimeout等，由浏览器内核的Timer模块处理，时间到达时，回调函数添加到任务队列中；</li> <li>Ajax,由浏览器内核的Network模块处理，网络请求返回后，添加到任务队列中。</li></ol> <h2 id="任务队列"><a href="#任务队列" class="header-anchor">#</a> 任务队列</h2> <p>如上示意图，任务队列存在多个，同一个任务队列内，按队列顺序被主线程取走；不同任务队列之间，存在着优先级，优先级高的优先获取（如用户I/O）；</p> <h3 id="任务队列的类型"><a href="#任务队列的类型" class="header-anchor">#</a> 任务队列的类型</h3> <ul><li>任务队列存在两种类型，一种为microtask queue,另一种为macrotask queue.</li> <li>图中所列出的任务队列均为macrotask queue，而es6的promise产生的队列为microtask queue。</li></ul> <h3 id="更完整的时间循环流程"><a href="#更完整的时间循环流程" class="header-anchor">#</a> 更完整的时间循环流程</h3> <p>将microtask加入到JS运行机制流程上，则：</p> <p>1.、2.、3.步同上
4. 主线程查询任务队列，执行microtask queue，将其按顺序执行，全部执行完毕；
5. 主线程查询任务队列，执行macrotask queue，取队首任务执行，执行完毕；
6. 重复4、5.</p> <p>microtask queue 中的所有callback处在同一个时间循环中，而macrotask queue中的callback有自己的事件循环。</p> <p>简而言之：同步环境执行-&gt;事件循环1（microtask queue的ALL）-&gt;事件循环2（macrotask queue中的一个）-&gt;事件循环1（microtask queue的ALL）-&gt;事件循环2（macrotask queue中的一个）...</p> <p>利用microtask queue可以形成一个同步执行的环境，但如果microtask queue太长，将导致macrotask任务长时间执行不了，最终导致用户I/O无响应等，所以使用需谨慎。</p> <h2 id="示例、验证"><a href="#示例、验证" class="header-anchor">#</a> 示例、验证</h2> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1, time = '</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>macroCallback<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2, time = '</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3, time = '</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>microCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">macroCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4, time = '</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

<span class="token keyword">function</span> <span class="token function">microCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5, time = '</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>     
</code></pre></div><p>结合第二节与第三节的分析，此处的执行流程应为：</p> <ul><li>同步环境：1-&gt;2-&gt;3</li> <li>事件循环1（microCallback）：5</li> <li>事件循环2（macroCallback）：4</li></ul> <p>运行结果如下：
<img src="https://images2015.cnblogs.com/blog/1094893/201704/1094893-20170419143740774-1438960433.png" alt="image"></p> <p>运行结果与预期一样，验证了在不同类型的任务队列中，microtask queue中的callback将优先执行。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js/js判断鼠标进入方向.html" class="prev">js判断鼠标进入方向</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.858ddfaa.js" defer></script><script src="/assets/js/2.5004e8d4.js" defer></script><script src="/assets/js/12.ad72436a.js" defer></script>
  </body>
</html>
